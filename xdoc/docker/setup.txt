yarn config set ignore-engines true
set NODE_OPTIONS=--max_old_space_size=6000

env:NODE_OPTIONS="--max-old-space-size=6000"

export DEEPTEST_OPS_HOME=/home/ubuntu/rd/docker && echo $DEEPTEST_OPS_HOME

sudo rm -rf ${DEEPTEST_OPS_HOME}/docker/mysql && mkdir -p ${DEEPTEST_OPS_HOME}/docker/mysql && \
    chmod 666 ${DEEPTEST_OPS_HOME}/docker/mysql
docker run \
    --name mysql \
    -p 53306:3306 \
    -v ${DEEPTEST_OPS_HOME}/docker/mysql/data:/var/lib/mysql:rw \
    -v ${DEEPTEST_OPS_HOME}/docker/mysql/conf.d:/etc/mysql/conf.d:rw \
    -e MYSQL_ROOT_PASSWORD=P2ssw0rd \
    --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci \
    --restart always \
    -d mysql:8.0.32

sudo rm -rf ${DEEPTEST_OPS_HOME}/docker/influxdb2 && mkdir -p ${DEEPTEST_OPS_HOME}/docker/influxdb2 && \
    chmod 666 ${DEEPTEST_OPS_HOME}/docker/influxdb2
docker run -itd \
    -p 58086:8086 \
    -v ${DEEPTEST_OPS_HOME}/docker/influxdb2/data:/var/lib/influxdb2 \
    -v ${DEEPTEST_OPS_HOME}/docker/influxdb2/config:/etc/influxdb2 \
    -e DOCKER_INFLUXDB_INIT_MODE=setup \
    -e DOCKER_INFLUXDB_INIT_USERNAME=root \
    -e DOCKER_INFLUXDB_INIT_PASSWORD=P2ssw0rd \
    -e DOCKER_INFLUXDB_INIT_ORG=deeptest \
    -e DOCKER_INFLUXDB_INIT_BUCKET=performance \
    -e DOCKER_INFLUXDB_INIT_RETENTION=1w \
    -e DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=influxdb-token \
    --name influxdb2 \
    influxdb:2.7.5-alpine

export DEEPTEST_OPS_HOME=/home/ubuntu/rd/docker && echo $DEEPTEST_OPS_HOME
sudo rm -rf ${DEEPTEST_OPS_HOME}/docker/deeptest && mkdir -p ${DEEPTEST_OPS_HOME}/docker/deeptest && \
    chmod 666 ${DEEPTEST_OPS_HOME}/docker/deeptest
docker run --privileged=true -itd \
    --link mysql \
    --link influxdb2 \
    -p 50022:22 -p 8085:8085 -p 8086:8086 -p 8087:8087 -p 9528:9528  \
    -v ${DEEPTEST_OPS_HOME}/docker/deeptest:/deeptest \
    -m 6G \
    --name deeptest \
    registry.cn-hangzhou.aliyuncs.com/com-deeptest/deeptest:1.0

docker exec -it deeptest /bin/bash

rm -rf ../deeptest/deeptest-ui
yarn build:demo --dest ../deeptest/deeptest-ui
CGO_ENABLED=1 go run cmd/server/main.go   启动服务端
CGO_ENABLED=1 go run cmd/agent/main.go    启动代理端

docker login --username=aaronchen2k@aliyun.com registry.cn-hangzhou.aliyuncs.com
docker commit -m "update" -a "aaron" deeptest registry.cn-hangzhou.aliyuncs.com/com-deeptest/deeptest:1.0
docker push registry.cn-hangzhou.aliyuncs.com/com-deeptest/deeptest:1.0

docker pull registry.cn-hangzhou.aliyuncs.com/com-deeptest/deeptest:1.0

wget -q https://repos.influxdata.com/influxdata-archive_compat.key
echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | tee /etc/apt/sources.list.d/influxdata.list

apt-get update && apt-get install influxdb2

CREATE DATABASE deeptest DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;

ps -ef | grep 'go run' | grep -v grep | awk '{print $2}' | xargs --no-run-if-empty kill -9
ps -ef | grep redis-server | grep -v grep | awk '{print $2}' | xargs --no-run-if-empty kill -9
lsof -i :9528 | grep -v grep | grep -v PID | awk '{print $2}' | xargs --no-run-if-empty kill -9
nohup redis-server > redis.log 2>&1 &
CGO_ENABLED=1
cd /rd/project/deeptest
nohup go run cmd/server/main.go > server.log 2>&1 &
nohup go run cmd/agent/main.go > agent.log 2>&1 &

apt install gcc
CGO_ENABLED=0 GOOS=darwin GOARCH=amd64

rm -rf ../deeptest/deeptest-ui && yarn build:demo --dest ../deeptest/deeptest-ui

vi ~/.bashrc
export GOPROXY=https://goproxy.cn
export GOROOT=/rd/sdk/go
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin:$GOROOT/bin