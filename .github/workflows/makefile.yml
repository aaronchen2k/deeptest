name: make server and agent

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: VM-4-15-ubuntu

    steps:
    - uses: actions/checkout@v3

#    - name: install dependencies
#      run: go get all

    - name: make server
      run: make compile_server_linux

    - name: make agent
      run: make compile_agent_linux

    - name: make agent
      run: make compile_ui
      
    - name: ssh deploy
      uses: easingthemes/ssh-deploy@v4.1.8
      with:
            SSH_PRIVATE_KEY: ${{ secrets.DT_PRIVATEKEY }}
            ARGS: "-rlgoDzvc -i --delete"
            SOURCE: "bin/linux/deeptest-server client/bin/linux/agent"
            REMOTE_HOST: ${{ secrets.DT_SERVER }}
            REMOTE_USER: ${{ secrets.DT_USERNAME }}
            TARGET: "/home/lighthouse/rd/project/deeptest/bin/linux"
            EXCLUDE: ""
            SCRIPT_BEFORE: |
              whoami
              mkdir -p /home/lighthouse/rd/project/deeptest/bin/linux
              ls -al /home/lighthouse/rd/project/deeptest/bin/linux
            SCRIPT_AFTER: |
              whoami
              ls -al /home/lighthouse/rd/project/deeptest/bin/linux
              echo $RSYNC_STDOUT
